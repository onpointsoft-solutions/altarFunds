{% extends "admin/base_site.html" %}
{% load admin_list static i18n %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'admin/css/enhanced_admin.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1>Dashboard Overview</h1>
            <p>Manage your church's financial and administrative operations</p>
        </div>
        <div class="date-time">
            <span id="currentDateTime"></span>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-church"></i>
            </div>
            <div class="stats-content">
                <h3>Total Churches</h3>
                <div class="stat-value">{{ stats.overview.total_churches }}</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> {{ stats.growth.church_growth }}% this month
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stats-content">
                <h3>Total Members</h3>
                <div class="stat-value">{{ stats.overview.total_users }}</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> {{ stats.growth.user_growth }}% this month
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-hand-holding-usd"></i>
            </div>
            <div class="stats-content">
                <h3>Total Giving</h3>
                <div class="stat-value">${{ stats.monthly_stats.total_giving|floatformat:2 }}</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> {{ stats.growth.giving_growth }}% this month
                </div>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <div class="stats-content">
                <h3>Transactions</h3>
                <div class="stat-value">{{ stats.overview.total_transactions }}</div>
                <div class="stat-change positive">
                    <i class="fas fa-arrow-up"></i> {{ stats.monthly_stats.successful_payments }} completed
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <div class="chart-header">
                <h3>Monthly Giving Trends</h3>
                <div class="chart-controls">
                    <select id="trendPeriod" class="chart-select">
                        <option value="6">Last 6 months</option>
                        <option value="12">Last 12 months</option>
                        <option value="24">Last 24 months</option>
                    </select>
                </div>
            </div>
            <div class="chart-canvas-container">
                <canvas id="givingTrendsChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-header">
                <h3>Income vs Expenses</h3>
                <div class="chart-controls">
                    <select id="comparisonPeriod" class="chart-select">
                        <option value="current">This Month</option>
                        <option value="last">Last Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
            </div>
            <div class="chart-canvas-container">
                <canvas id="incomeExpenseChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Activity Section -->
    <div class="activity-section">
        <div class="recent-activity">
            <div class="section-header">
                <h3>Recent Activity</h3>
                <a href="#" class="view-all-link">View All</a>
            </div>
            <div class="activity-list">
                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-icon">
                        <i class="fas fa-{% if activity.action == 'create' %}plus{% elif activity.action == 'update' %}edit{% elif activity.action == 'delete' %}trash{% else %}info{% endif %}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">{{ activity.user.first_name }} {{ activity.user.last_name }}</div>
                        <div class="activity-description">{{ activity.get_action_display }} {{ activity.content_type.name }}</div>
                        <div class="activity-time">{{ activity.timestamp|timesince }} ago</div>
                    </div>
                </div>
                {% empty %}
                <div class="no-activity">
                    <i class="fas fa-inbox"></i>
                    <p>No recent activity</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="top-churches">
            <div class="section-header">
                <h3>Top Performing Churches</h3>
                <a href="#" class="view-all-link">View All</a>
            </div>
            <div class="churches-list">
                {% for church in top_churches %}
                <div class="church-item">
                    <div class="church-rank">{{ forloop.counter }}</div>
                    <div class="church-info">
                        <div class="church-name">{{ church.name }}</div>
                        <div class="church-stats">{{ church.transaction_count }} transactions</div>
                    </div>
                    <div class="church-amount">
                        ${{ church.total_giving|floatformat:2 }}
                    </div>
                </div>
                {% empty %}
                <div class="no-churches">
                    <i class="fas fa-chart-line"></i>
                    <p>No church data available</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- System Health -->
    <div class="system-health-section">
        <div class="section-header">
            <h3>System Health</h3>
            <div class="health-status {% if system_health.status == 'healthy' %}healthy{% elif system_health.status == 'warning' %}warning{% else %}critical{% endif %}">
                <i class="fas fa-{% if system_health.status == 'healthy' %}check-circle{% elif system_health.status == 'warning' %}exclamation-triangle{% else %}times-circle{% endif %}"></i>
                {{ system_health.status|title }}
            </div>
        </div>
        <div class="health-metrics">
            <div class="health-metric">
                <div class="metric-label">CPU Usage</div>
                <div class="metric-value">{{ system_health.cpu_usage }}%</div>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: {{ system_health.cpu_usage }}%"></div>
                </div>
            </div>
            <div class="health-metric">
                <div class="metric-label">Memory Usage</div>
                <div class="metric-value">{{ system_health.memory_usage }}%</div>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: {{ system_health.memory_usage }}%"></div>
                </div>
            </div>
            <div class="health-metric">
                <div class="metric-label">Disk Usage</div>
                <div class="metric-value">{{ system_health.disk_usage }}%</div>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: {{ system_health.disk_usage }}%"></div>
                </div>
            </div>
            <div class="health-metric">
                <div class="metric-label">Active Sessions</div>
                <div class="metric-value">{{ system_health.active_sessions }}</div>
                <div class="metric-bar">
                    <div class="metric-fill" style="width: 60%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions-section">
        <div class="section-header">
            <h3>Quick Actions</h3>
        </div>
        <div class="actions-grid">
            <a href="{% url 'admin:churches_church_add' %}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-plus-circle"></i>
                </div>
                <div class="action-content">
                    <h4>Add Church</h4>
                    <p>Register a new church</p>
                </div>
            </a>
            <a href="{% url 'admin:accounts_user_add' %}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="action-content">
                    <h4>Add User</h4>
                    <p>Create a new user account</p>
                </div>
            </a>
            <a href="{% url 'admin:giving_givingtransaction_add' %}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-donate"></i>
                </div>
                <div class="action-content">
                    <h4>Record Giving</h4>
                    <p>Add a new giving transaction</p>
                </div>
            </a>
            <a href="{% url 'admin:reports_report_changelist' %}" class="action-card">
                <div class="action-icon">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div class="action-content">
                    <h4>View Reports</h4>
                    <p>Generate financial reports</p>
                </div>
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extrajs %}
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    // Update date/time
    function updateDateTime() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        document.getElementById('currentDateTime').textContent = now.toLocaleDateString('en-US', options);
    }
    updateDateTime();
    setInterval(updateDateTime, 60000);

    // Giving Trends Chart
    const givingTrendsCtx = document.getElementById('givingTrendsChart').getContext('2d');
    const givingTrendsChart = new Chart(givingTrendsCtx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Total Giving',
                data: [12000, 15000, 13500, 17000, 19000, 22000],
                borderColor: '#006493',
                backgroundColor: 'rgba(0, 100, 147, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Income vs Expenses Chart
    const incomeExpenseCtx = document.getElementById('incomeExpenseChart').getContext('2d');
    const incomeExpenseChart = new Chart(incomeExpenseCtx, {
        type: 'bar',
        data: {
            labels: ['Tithe', 'Offering', 'Missions', 'Building', 'Other'],
            datasets: [{
                label: 'Income',
                data: [8000, 6000, 3000, 2000, 3000],
                backgroundColor: '#22c55e'
            }, {
                label: 'Expenses',
                data: [5000, 2000, 1500, 1000, 2000],
                backgroundColor: '#ef4444'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // Handle period changes
    document.getElementById('trendPeriod').addEventListener('change', function() {
        // Update chart data based on selected period
        console.log('Period changed to:', this.value);
    });

    document.getElementById('comparisonPeriod').addEventListener('change', function() {
        // Update chart data based on selected period
        console.log('Period changed to:', this.value);
    });
});
</script>

<style>
/* Additional dashboard-specific styles */
.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: var(--altar-radius-lg);
    box-shadow: var(--altar-shadow-sm);
}

.welcome-section h1 {
    color: var(--altar-gray-900);
    font-size: var(--altar-font-size-3xl);
    margin: 0 0 0.5rem 0;
}

.welcome-section p {
    color: var(--altar-gray-600);
    margin: 0;
}

.date-time {
    color: var(--altar-gray-500);
    font-size: var(--altar-font-size-sm);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stats-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: white;
    border-radius: var(--altar-radius-lg);
    box-shadow: var(--altar-shadow-sm);
    transition: all 0.2s ease;
}

.stats-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--altar-shadow-md);
}

.stats-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--altar-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
}

.stats-card:nth-child(1) .stats-icon { background: var(--altar-primary); }
.stats-card:nth-child(2) .stats-icon { background: var(--altar-secondary); }
.stats-card:nth-child(3) .stats-icon { background: var(--altar-success); }
.stats-card:nth-child(4) .stats-icon { background: var(--altar-warning); }

.stats-content h3 {
    color: var(--altar-gray-600);
    font-size: var(--altar-font-size-sm);
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.stat-value {
    color: var(--altar-gray-900);
    font-size: var(--altar-font-size-2xl);
    font-weight: 700;
    margin: 0 0 0.5rem 0;
}

.stat-change {
    font-size: var(--altar-font-size-sm);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.stat-change.positive { color: var(--altar-success); }
.stat-change.negative { color: var(--altar-error); }

.charts-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.chart-container {
    background: white;
    border-radius: var(--altar-radius-lg);
    box-shadow: var(--altar-shadow-sm);
    overflow: hidden;
}

.chart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--altar-gray-200);
}

.chart-header h3 {
    color: var(--altar-gray-900);
    font-size: var(--altar-font-size-lg);
    margin: 0;
}

.chart-select {
    padding: 0.5rem 1rem;
    border: 1px solid var(--altar-gray-300);
    border-radius: var(--altar-radius-md);
    font-size: var(--altar-font-size-sm);
    background: white;
}

.chart-canvas-container {
    padding: 1.5rem;
    height: 300px;
}

.activity-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.recent-activity, .top-churches {
    background: white;
    border-radius: var(--altar-radius-lg);
    box-shadow: var(--altar-shadow-sm);
    overflow: hidden;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--altar-gray-200);
}

.section-header h3 {
    color: var(--altar-gray-900);
    font-size: var(--altar-font-size-lg);
    margin: 0;
}

.view-all-link {
    color: var(--altar-primary);
    text-decoration: none;
    font-size: var(--altar-font-size-sm);
    font-weight: 600;
}

.view-all-link:hover {
    text-decoration: underline;
}

.activity-list, .churches-list {
    padding: 1rem;
}

.activity-item, .church-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: var(--altar-radius-md);
    transition: background-color 0.2s ease;
}

.activity-item:hover, .church-item:hover {
    background-color: var(--altar-gray-50);
}

.activity-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    color: white;
    background: var(--altar-primary);
}

.church-rank {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    color: white;
    background: var(--altar-primary);
}

.activity-content, .church-info {
    flex: 1;
}

.activity-title, .church-name {
    color: var(--altar-gray-900);
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.activity-description, .church-stats {
    color: var(--altar-gray-600);
    font-size: var(--altar-font-size-sm);
    margin-bottom: 0.25rem;
}

.activity-time {
    color: var(--altar-gray-500);
    font-size: var(--altar-font-size-xs);
}

.church-amount {
    color: var(--altar-gray-900);
    font-weight: 700;
    font-size: var(--altar-font-size-lg);
}

.no-activity, .no-churches {
    text-align: center;
    padding: 2rem;
    color: var(--altar-gray-500);
}

.no-activity i, .no-churches i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    display: block;
}

.system-health-section {
    background: white;
    border-radius: var(--altar-radius-lg);
    box-shadow: var(--altar-shadow-sm);
    overflow: hidden;
    margin-bottom: 2rem;
}

.health-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    border-radius: var(--altar-radius-md);
    font-size: var(--altar-font-size-sm);
    font-weight: 600;
}

.health-status.healthy {
    background-color: var(--altar-success-bg);
    color: var(--altar-success);
}

.health-status.warning {
    background-color: var(--altar-warning-bg);
    color: var(--altar-warning);
}

.health-status.critical {
    background-color: var(--altar-error-bg);
    color: var(--altar-error);
}

.health-metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem 1.5rem;
}

.health-metric {
    padding: 1rem;
    border-radius: var(--altar-radius-md);
    background-color: var(--altar-gray-50);
}

.metric-label {
    color: var(--altar-gray-600);
    font-size: var(--altar-font-size-sm);
    margin-bottom: 0.5rem;
}

.metric-value {
    color: var(--altar-gray-900);
    font-size: var(--altar-font-size-lg);
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.metric-bar {
    height: 8px;
    background-color: var(--altar-gray-200);
    border-radius: var(--altar-radius-sm);
    overflow: hidden;
}

.metric-fill {
    height: 100%;
    background-color: var(--altar-primary);
    transition: width 0.3s ease;
}

.quick-actions-section {
    background: white;
    border-radius: var(--altar-radius-lg);
    box-shadow: var(--altar-shadow-sm);
    overflow: hidden;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem 1.5rem;
}

.action-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    border-radius: var(--altar-radius-lg);
    background-color: var(--altar-gray-50);
    text-decoration: none;
    color: inherit;
    transition: all 0.2s ease;
}

.action-card:hover {
    background-color: var(--altar-primary-bg);
    transform: translateY(-2px);
    box-shadow: var(--altar-shadow-md);
}

.action-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--altar-radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
    background: var(--altar-primary);
}

.action-content h4 {
    color: var(--altar-gray-900);
    font-size: var(--altar-font-size-base);
    font-weight: 600;
    margin: 0 0 0.25rem 0;
}

.action-content p {
    color: var(--altar-gray-600);
    font-size: var(--altar-font-size-sm);
    margin: 0;
}

@media (max-width: 768px) {
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .charts-section {
        grid-template-columns: 1fr;
    }
    
    .activity-section {
        grid-template-columns: 1fr;
    }
    
    .health-metrics {
        grid-template-columns: 1fr;
    }
    
    .actions-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}
